!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("chart.js"),require("chart.js/helpers")):"function"==typeof define&&define.amd?define(["chart.js","chart.js/helpers"],e):(t="undefined"!=typeof globalThis?globalThis:t||self)["chartjs-plugin-outlabels3"]=e(t.Chart,t.Chart.helpers)}(this,(function(t,e){"use strict";class i{constructor(){this.top=4,this.right=4,this.bottom=4,this.left=4}}class s{constructor(){this.family="'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",this.style="normal",this.resizable=!0,this.lineHeight=1.2,this.lineSize=0}}class r{constructor(){this.display=!0,this.text="%l %p",this.textAlign="center",this.color="white",this.borderRadius=0,this.borderWidth=0,this.lineWidth=2,this.length=40,this.percentPrecision=1,this.valuePrecision=3,this.padding=new i,this.font=new s}backgroundColor(t){return t.dataset.backgroundColor}borderColor(t){return t.dataset.backgroundColor}lineColor(t){return t.dataset.backgroundColor}}function h(t){return!t||e.isNullOrUndef(t.size)||e.isNullOrUndef(t.family)?"":(t.style?t.style+" ":"")+(t.weight?t.weight+" ":"")+t.size+"px "+t.family}function a(i,s){const r=t.Chart.defaults;let h=e.valueOrDefault(i.size,r.font.size);return i.resizable&&(h=function(t,e,i){const s=t/100*2.5;if(e&&s<e)return e;if(i&&s>i)return i;return s}(s,i.minSize,i.maxSize)),i.lineSize=e.toLineHeight(i.lineHeight.toString(),h),i.size=h,i}class l{constructor(t,i,r,l){var o,n;if(this.rect={height:0,width:0,x:0,y:0},!r.display)throw new Error("Label display property is set to false.");this.ctx=t,this.index=i,this.context=l;const c=l.labels[i];let d=e.resolve([r.text],l,i);d||(d="%l %p"),d=d.replace(/%l/gi,c),(d.match(/%v\.?(\d*)/gi)||[]).map((function(t){const e=t.replace(/%v\./gi,"");return e.length?+e:r.valuePrecision})).forEach((function(t){d&&(d=d.replace(/%v\.?(\d*)/i,l.value.toFixed(t)))})),(d.match(/%p\.?(\d*)/gi)||[]).map((function(t){const e=t.replace(/%p\./gi,"");return e.length?+e:r.percentPrecision})).forEach((function(t){d&&(d=d.replace(/%p\.?(\d*)/i,(100*l.percent).toFixed(t)+"%"))}));const u=d.match(/[^\r\n]+/g);if(!u||!u.length)throw new Error("No text to show.");for(let t=0;t<u.length;++t)u[t]=u[t].trim();this.encodedText=r.text,this.text=d,this.lines=u,this.label=c,this.value=l.value;const f=Object.assign(new s,r.font);this.style={backgroundColor:e.resolve([r.backgroundColor,"black"],l,i),borderColor:e.resolve([r.borderColor,"black"],l,i),borderRadius:e.resolve([r.borderRadius,0],l,i),borderWidth:e.resolve([r.borderWidth,0],l,i),lineWidth:e.resolve([r.lineWidth,2],l,i),lineColor:e.resolve([r.lineColor,"black"],l,i),color:e.resolve([r.color,"white"],l,i),font:a(null!==(o=e.resolve([f]))&&void 0!==o?o:f,parseFloat(t.canvas.style.height.slice(0,-2))),padding:e.toPadding(e.resolve([r.padding],l,i)),textAlign:e.resolve([r.textAlign,"left"],l,i)},this.length=null!==(n=e.resolve([r.length,40],l,i))&&void 0!==n?n:40,this.size=function(t,e,i){const s=t.font;let r=0;t.font=h(i);for(let i=0;i<e.length;++i)r=Math.max(t.measureText(e[i]).width,r);return t.font=s,{height:e.length*i.lineSize,width:r}}(t,this.lines,this.style.font)}get center(){return{x:this.x,y:this.y}}computeRect(){return{x:this.x+(this.nx<0?-this.size.width:0)-this.style.padding.left-this.style.borderWidth,y:this.y-this.size.height/2-this.style.padding.top-this.style.borderWidth,width:this.size.width+2*this.style.borderWidth+this.style.padding.width,height:this.size.height+2*this.style.borderWidth+this.style.padding.height}}drawText(){const t=this.style.font,e=this.style.color;if(!this.lines.length||!e)return;this.ctx.font=h(this.style.font),this.ctx.fillStyle=e,this.ctx.textAlign=this.nx<0?"right":"left",this.ctx.textBaseline="middle";const i=this.x;let s=this.y;for(let e=0;e<this.lines.length;++e)this.ctx.fillText(this.lines[e],Math.round(i),Math.round(s),Math.round(this.size.width)),s+=t.lineSize}drawRect(){this.ctx.beginPath(),function(t,e,i,s,r,h){const a=Math.PI/2;if(h){const l=Math.min(h,r/2,s/2),o=e+l,n=i+l,c=e+s-l,d=i+r-l;t.moveTo(e,n),o<c&&n<d?(t.arc(o,n,l,-Math.PI,-a),t.arc(c,n,l,-a,0),t.arc(c,d,l,0,a),t.arc(o,d,l,a,Math.PI)):o<c?(t.moveTo(o,i),t.arc(c,n,l,-a,a),t.arc(o,n,l,a,Math.PI+a)):n<d?(t.arc(o,n,l,-Math.PI,0),t.arc(o,d,l,0,Math.PI)):t.arc(o,n,l,-Math.PI,Math.PI),t.closePath(),t.moveTo(e,i)}else t.rect(e,i,s,r)}(this.ctx,this.rect.x,this.rect.y,this.rect.width,this.rect.height,this.style.borderRadius),this.ctx.closePath(),this.style.backgroundColor&&(this.ctx.fillStyle=this.style.backgroundColor||"black",this.ctx.fill()),this.style.borderColor&&this.style.borderWidth&&(this.ctx.strokeStyle=this.style.borderColor,this.ctx.lineWidth=this.style.borderWidth,this.ctx.lineJoin="miter",this.ctx.stroke())}drawLine(){this.ctx.save(),this.ctx.strokeStyle=this.style.lineColor,this.ctx.lineWidth=this.style.lineWidth,this.ctx.lineJoin="miter",this.ctx.beginPath(),this.ctx.moveTo(this.x1,this.y1),this.ctx.lineTo(this.x,this.y),this.ctx.stroke(),this.ctx.restore()}draw(){this.drawRect(),this.drawText()}updateRects(){this.rect=this.computeRect()}positionCenter(t){this.arc=t;const e=this.context.chart,i=(t.startAngle+t.endAngle)/2,s=Math.cos(i),r=Math.sin(i),h=(e.chartArea.left+e.chartArea.right)/2,a=(e.chartArea.top+e.chartArea.bottom)/2,l=t.outerRadius,o=l*s+h,n=l*r+a,c=o+s*this.length,d=n+r*this.length;this.x1=o,this.y1=n,this.x=c,this.y=d,this.nx=s}}const o=new class{constructor(){this.labels=new Map}set(t){this.labels.set(t,new Map)}get(t){return this.labels.get(t)}setLabel(t,e,i){const s=this.get(t);s&&(null==s||s.set(e,i))}adjustQuadrant(t){if(t.length<2)return!1;t.sort(((t,e)=>t.rect.y-e.rect.y));let e=0,i=!1,s=0;for(let r=0;r<t.length;r++){const h=t[r],a=h.rect;let l=a.y-e;l<0&&(a.y-=l,h.y-=l,i=!0);s+=Math.max(-l,0),e=a.y+h.rect.height}if(s>0){const e=-s/t.length;0!==e&&(i=!0);for(let i=0;i<t.length;i++){const s=t[i];s.rect.y+=e,s.rect.y+=e}}return i}recalculateX(t,e){if(e.length<1)return;const i=(t.chartArea.left+t.chartArea.right)/2,s=(t.chartArea.top+t.chartArea.bottom)/2,r=e[0].arc.outerRadius,h=e[0].nx<0?-1:1;let a=0,l=0;e.forEach((t=>{const e=Math.abs(t.rect.y-s);if(e>a){const s=t.rect.x-i,h=r+t.length;l=Math.abs(s)<h?Math.sqrt(e*e/(1-s*s/h/h)):h,a=e}}));const o=l*l;e.forEach((t=>{const e=Math.abs(t.rect.y-s),a=r+t.length,l=a*a,n=Math.sqrt((1-Math.abs(e*e/o))*l),c=i+n*h;t.x=c}))}avoidOverlap(t){const e=this.get(t.id);if(e){const i=(t.chartArea.left+t.chartArea.right)/2,s=(t.chartArea.top+t.chartArea.bottom)/2,r=[],h=[],a=[],l=[];e.forEach((t=>{t.x<i?t.y<s?r.push(t):a.push(t):t.y<s?h.push(t):l.push(t)})),this.adjustQuadrant(r)&&this.recalculateX(t,r),this.adjustQuadrant(h)&&this.recalculateX(t,h),this.adjustQuadrant(a)&&this.recalculateX(t,a),this.adjustQuadrant(l)&&this.recalculateX(t,l)}}};var n={id:"outlabels",beforeInit:function(t){o.set(t.id)},afterDatasetUpdate:function(t,i,s){const h=Object.assign(new r,s),a=t.config.data.labels,n=t.data.datasets[i.index],c=i.meta.data,d=t.ctx;d.save();for(let s=0;s<c.length;++s){const r=c[s];let u=null;const f=n.data[s]/n.data.reduce(((t,e)=>t+e)),g={chart:t,dataIndex:s,dataset:n,labels:a,datasetIndex:i.index,value:n.data[s],percent:f};if(e.resolve([h.display,!1],g,s)&&r&&t.getDataVisibility(i.index))try{u=new l(d,s,h,g)}catch(t){console.warn(t),u=null}u&&o.setLabel(t.id,s,u)}d.restore()},afterDatasetDraw:function(t,e){const i=t.ctx,s=e.meta.data;i.save();const r=o.get(t.id);r&&(r.forEach((t=>{t.positionCenter(s[t.index]),t.updateRects()})),o.avoidOverlap(t),r.forEach((t=>{t.updateRects(),t.draw(),t.drawLine()})),i.restore())}};return t.Chart.register(n),n}));
